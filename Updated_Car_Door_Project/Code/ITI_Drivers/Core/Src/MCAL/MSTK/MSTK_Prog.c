/*******************************************************************************************************
 *******************************************************************************************************
AUTHOR  : MOHAMED ABDELAZIZ
MICRO   : STM32F401CCU6
LAYER   : MCAL
DRIVER  : STK_Driver
File    : Program File
Version : 1.0
Date	: 15/8/2023
********************************************************************************************************
********************************************************************************************************/

/*******************************************************************************************************/
/*                                STD Types LIB & BIT Math & Inclusions                                */
/*******************************************************************************************************/

#include "../../LIB/STD_Types.h"
#include "../../LIB/BIT_Math.h"
#include "MSTK_Config.h"
#include "MSTK_Int.h"
#include "MSTK_Private.h"

/*******************************************************************************************************/
/*                                          Global Variables                                           */
/*******************************************************************************************************/



/*******************************************************************************************************/
/*                                         Callback Function                                           */
/*******************************************************************************************************/

void(*callbacksys)(void) = NULL_ptr;

/*******************************************************************************************************/
/*                                      Functions Implementations                                      */
/*******************************************************************************************************/

/*******************************************************************************************************/
/*                                        01- MSTK_voidInit                                            */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to enable the systick and initialize the clock source           */
/* 2- Function Input       -> No Thing              											       */
/* 3- Function Return      -> No Thing                                                                 */
/*******************************************************************************************************/

void MSTK_voidInit(void){
	SET_BIT(MSTK -> CTRL, CLKSRC);
}

/*******************************************************************************************************/
/*                                      02- MSTK_voidIntState                                          */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to enable systick exception request                             */
/* 2- Function Input       -> No Thing              											       */
/* 3- Function Return      -> No Thing                                                                 */
/*******************************************************************************************************/

void MSTK_voidIntState(void){
	SET_BIT(MSTK -> CTRL, INTEN);
}

/*******************************************************************************************************/
/*                                       03- MSTK_voidStart                                            */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to set the value the systick should start counting down from    */
/* 2- Function Input       -> Preload Value          											       */
/* 3- Function Return      -> No Thing                                                                 */
/*******************************************************************************************************/

void MSTK_voidStart(u32 Copy_u8PreloadValue){
	MSTK -> LOAD |= (Copy_u8PreloadValue - 1);
	MSTK -> VAL = 0;
	SET_BIT(MSTK -> CTRL, EN);
}

/*******************************************************************************************************/
/*                                      04- MSTK_u8ReadFlag                                            */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to get if the systick was done counting                         */
/* 2- Function Input       -> No Thing              											       */
/* 3- Function Return      -> 1 (Done), 0 (Not Done)                                                   */
/*******************************************************************************************************/

u8 MSTK_u8ReadFlag(void){
	return (GET_BIT(MSTK -> CTRL, CNTFLAG));
}

/*******************************************************************************************************/
/*                                     05- MSTK_voidDelayUsec                                          */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to be used for delay for every microsecond                      */
/* 2- Function Input       -> Delay time in microseconds   							    		       */
/* 3- Function Return      -> No Thing                                                                 */
/*******************************************************************************************************/

void MSTK_voidDelayUsec(u32 Copy_u8DelayUsec){
	CLR_BIT(MSTK -> CTRL, INTEN);
	MSTK_voidStart(Copy_u8DelayUsec * 2);
	while(MSTK_u8ReadFlag()){}
}

/*******************************************************************************************************/
/*                                     06- MSTK_voidDelayMsec                                          */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to be used for delay for every millisecond                      */
/* 2- Function Input       -> Delay time in milliseconds   							    		       */
/* 3- Function Return      -> No Thing                                                                 */
/*******************************************************************************************************/

void MSTK_voidDelayMsec(u32 Copy_u8DelayMsec){
	CLR_BIT(MSTK -> CTRL, INTEN);
	MSTK_voidStart(Copy_u8DelayMsec * 2000);
	while(MSTK_u8ReadFlag()){}
}

/*******************************************************************************************************/
/*                                    07- MSTK_u32GetElapsedTime                                       */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to get the elapsed time                                         */
/* 2- Function Input       -> No Thing              											       */
/* 3- Function Return      -> Elapsed time                                                             */
/*******************************************************************************************************/

u32 MSTK_u32GetElapsedTime(void){
	return ((MSTK -> LOAD) - (MSTK -> VAL));
}

/*******************************************************************************************************/
/*                                   08- MSTK_u32GetRemainingTime                                      */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to get the remaining time                                       */
/* 2- Function Input       -> No Thing              											       */
/* 3- Function Return      -> Remaining time                                                           */
/*******************************************************************************************************/

u32 MSTK_u32GetRemainingTime(void){
	return (MSTK -> VAL);
}

/*******************************************************************************************************/
/*                                         09- CALLBACKSYS                                             */
/*-----------------------------------------------------------------------------------------------------*/
/* 1- Function Description -> Function to set the callback function to the user's choice               */
/* 2- Function Input       -> Callback pointer to function              						       */
/* 3- Function Return      -> No Thing                                                                 */
/*******************************************************************************************************/

void CALLBACKSYS(void(*callback)(void)){
	callbacksys = callback;
}

void SysTick_Handler(void){
	callbacksys();

}



